// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================
// MODELO DE USUARIOS
// =============================================
model User {
  id                Int       @id @default(autoincrement())
  email             String    @unique
  password          String    // Hasheada con bcrypt
  nombre            String
  apellidoPaterno   String?
  apellidoMaterno   String?
  role              String    @default("user") // "admin", "company", "user", "recruiter", "specialist", "candidate", "vendor"
  isActive          Boolean   @default(true)
  emailVerified     DateTime?
  lastLogin         DateTime?
  
  // Sistema de Créditos (solo para empresas)
  credits           Int       @default(0)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relaciones
  companyRequest    CompanyRequest?
  jobs              Job[]
  applications      Application[]
  creditPurchases   CreditPurchase[]

  specialty               String?
  recruiterAssignments    JobAssignment[] @relation("RecruiterAssignments")
  specialistAssignments   JobAssignment[] @relation("SpecialistAssignments")

  // Relación con Candidate (para role="candidate")
  candidate               Candidate?

  // Códigos de descuento (para vendors)
  discountCodes           DiscountCode[] @relation("VendorCodes")

  // Notas de evaluación (para recruiters y specialists)
  evaluationNotes         EvaluationNote[] @relation("EvaluationNoteAuthor")

  // Solicitudes de entrevista (para empresas)
  interviewRequests       InterviewRequest[] @relation("InterviewRequester")

  @@index([email])
  @@index([role])
  @@index([isActive])
}

// =============================================
// SOLICITUDES DE EMPRESAS
// =============================================
model CompanyRequest {
  id                        Int       @id @default(autoincrement())
  
  // Información del representante
  nombre                    String
  apellidoPaterno           String
  apellidoMaterno           String
  
  // Información de la empresa
  nombreEmpresa             String
  correoEmpresa             String
  sitioWeb                  String?
  razonSocial               String
  rfc                       String
  direccionEmpresa          String
  latitud                   Float?
  longitud                  Float?

  // Logo de la empresa
  logoUrl                   String?

  // Documentos
  identificacionUrl         String?
  documentosConstitucionUrl String?
  
  // Estado y tracking
  status                    String    @default("pending") // pending, approved, rejected
  rejectionReason           String?
  
  // Timestamps
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  approvedAt                DateTime?
  
  // Relación con Usuario (se crea cuando se aprueba)
  userId                    Int?      @unique
  user                      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([status])
  @@index([createdAt])
  @@index([rfc])
  @@index([correoEmpresa])
}

// =============================================
// MENSAJES DE CONTACTO
// =============================================
model ContactMessage {
  id        Int      @id @default(autoincrement())
  nombre    String
  email     String
  telefono  String?
  mensaje   String
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([email])
}

// =============================================
// VACANTES/EMPLEOS
// =============================================
model Job {
  id              Int       @id @default(autoincrement())
  title           String
  company         String
  location        String
  salary          String
  salaryMin       Int?      // Salario mínimo en MXN
  salaryMax       Int?      // Salario máximo en MXN (diferencia máxima: $10,000)
  jobType         String    // "Tiempo Completo", "Medio Tiempo", "Contrato"
  workMode        String    @default("presential") // "remote", "hybrid", "presential"
  description     String    @db.Text
  requirements    String?   @db.Text
  status          String    @default("active") // "active", "paused", "closed", "draft"
  closedReason    String?   // 'success' (contratación exitosa), 'cancelled' (cancelada sin contratar)
  companyRating   Float?    @default(5.0)
  
  // Sistema de Créditos
  creditCost      Int       @default(0) // Cuántos créditos costó publicar
  
  // Campos para calcular costo
  profile         String?   // "Tecnología", "Diseño Gráfico", etc. (del catálogo de especialidades)
  subcategory     String?   // Sub-especialidad dentro del profile
  seniority       String?   // "Practicante", "Jr", "Middle", "Sr", "Director"
  educationLevel  String?   // "Sin requisito", "Primaria", "Secundaria", "Preparatoria/Bachillerato", "Licenciatura", "Maestría", "Doctorado"

  // Campos extendidos para mejor matching
  habilidades           String?   @db.Text  // JSON array as string
  responsabilidades     String?   @db.Text
  resultadosEsperados   String?   @db.Text
  valoresActitudes      String?   @db.Text
  informacionAdicional  String?   @db.Text
  notasInternas         String?   @db.Text  // Info interna para INAKAT, no visible para candidatos

  // Vacante confidencial (oculta nombre, dirección y logo de empresa en vista pública)
  isConfidential  Boolean   @default(false)

  // Relación con la empresa que publicó
  userId          Int?
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Relación con aplicaciones
  applications    Application[]

  assignment      JobAssignment?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  expiresAt       DateTime?
  editableUntil   DateTime? // Tiempo límite para editar (4 horas después de crear)
  
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@index([location])
  @@index([jobType])
  @@index([workMode])
  @@index([profile])
  @@index([seniority])
}

// =============================================
// APLICACIONES A VACANTES
// =============================================
model Application {
  id              Int       @id @default(autoincrement())

  // Relaciones
  jobId           Int
  job             Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  userId          Int?
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Información del candidato
  candidateName   String
  candidateEmail  String
  candidatePhone  String?

  // Documentos
  cvUrl           String?
  coverLetter     String?   @db.Text

  // Estado
  status          String    @default("pending") // "pending", "reviewing", "evaluating", "sent_to_specialist", "sent_to_company", "company_interested", "interviewed", "rejected", "accepted", "injected_by_admin", "discarded", "archived"
  notes           String?   @db.Text

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  reviewedAt      DateTime?

  // Notas de evaluación
  evaluationNotes EvaluationNote[]

  // Solicitudes de entrevista
  interviewRequests InterviewRequest[]

  @@index([jobId])
  @@index([userId])
  @@index([status])
  @@index([candidateEmail])
  @@index([createdAt])
}

// =============================================
// MATRIZ DE PRECIOS (Sistema de Créditos)
// =============================================
model PricingMatrix {
  id          Int      @id @default(autoincrement())
  
  // Categorías
  profile     String   // "Tecnología", "Arquitectura", "Diseño Gráfico", etc.
  seniority   String   // "Practicante", "Jr", "Middle", "Sr", "Director"
  workMode    String   // "remote", "hybrid", "presential"
  location    String?  // "Monterrey", "CDMX", "GDL", etc. (opcional)
  
  // Costo en créditos
  credits     Int

  // Salario mínimo requerido para esta combinación
  minSalary   Int?     // Salario mínimo en MXN que debe ofrecer la empresa

  // Metadatos
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([profile, seniority, workMode, location])
  @@index([profile])
  @@index([seniority])
  @@index([workMode])
  @@index([location])
  @@index([isActive])
}

// =============================================
// PAQUETES DE CRÉDITOS (Configurables por Admin)
// =============================================
model CreditPackage {
  id              Int      @id @default(autoincrement())
  name            String   // "1 Crédito", "Pack 10", etc.
  credits         Int      // Cantidad de créditos
  price           Float    // Precio en MXN
  pricePerCredit  Float    // Precio por crédito (calculado)
  badge           String?  // "MÁS POPULAR", "PROMOCIÓN", null
  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive])
  @@index([sortOrder])
}

// =============================================
// COMPRAS DE CRÉDITOS
// =============================================
model CreditPurchase {
  id              Int      @id @default(autoincrement())
  
  // Relación con empresa
  userId          Int
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Detalles de la compra
  amount          Int      // Cantidad de créditos comprados
  pricePerCredit  Float    // Precio por crédito (en MXN)
  totalPrice      Float    // Precio total pagado
  packageType     String?  // "single", "pack_10", "pack_15", "pack_20"
  
  // Información de pago (Conekta)
  paymentStatus   String   @default("pending") // "pending", "paid", "failed", "refunded"
  paymentId       String?  @unique // ID de Conekta
  paymentMethod   String?  // "card", "oxxo", "spei"
  receiptUrl      String?  // URL del recibo
  
  // Timestamps
  createdAt       DateTime @default(now())
  paidAt          DateTime?

  // Uso de código de descuento
  discountCodeUse DiscountCodeUse?

  @@index([userId])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([paymentId])
}

// =============================================
// HISTORIAL DE CRÉDITOS (Auditoría)
// =============================================
model CreditTransaction {
  id            Int      @id @default(autoincrement())
  
  // Relación con empresa
  userId        Int
  
  // Tipo de transacción
  type          String   // "purchase", "spend", "refund", "admin_adjustment"
  amount        Int      // Cantidad (positivo = suma, negativo = resta)
  balanceBefore Int      // Balance antes de la transacción
  balanceAfter  Int      // Balance después de la transacción
  
  // Referencias
  jobId         Int?     // Si se gastó en una vacante
  purchaseId    Int?     // Si fue una compra
  
  // Descripción
  description   String?
  
  // Timestamp
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([jobId])
}

// =============================================
// CANDIDATOS (Inyectados por Admin)
// =============================================
model Candidate {
  id              Int       @id @default(autoincrement())
  
  // Datos personales
  nombre          String
  apellidoPaterno String
  apellidoMaterno String?
  email           String    @unique
  telefono        String?
  
  // Filtros demográficos
  sexo            String?   // "M", "F", "Otro"
  fechaNacimiento DateTime?

  // Ubicación personal
  ciudad           String?
  estado           String?
  ubicacionCercana String?  // Colonia, zona o referencia cercana

  // Educación (campos legacy para compatibilidad)
  universidad     String?
  carrera         String?
  nivelEstudios   String?   // "Licenciatura", "Maestría", "Doctorado", "Técnico"

  // Educación múltiple (JSON array de entradas educativas)
  // Formato: [{nivel, institucion, carrera, añoInicio, añoFin, estatus}]
  educacion       String?   @db.Text
  
  // Experiencia (años totales - se calcula automáticamente)
  añosExperiencia Int       @default(0)
  
  // Especialidad/Perfil
  profile         String?   // "Tecnología", "Diseño Gráfico", etc.
  subcategory     String?   // Sub-especialidad dentro del profile
  seniority       String?   // "Practicante", "Jr", "Middle", "Sr", "Director"
  
  // Documentos y links
  cvUrl           String?
  portafolioUrl   String?
  linkedinUrl     String?

  // Foto de perfil
  fotoUrl         String?

  // Fuente del candidato
  source          String    @default("manual") // "manual", "linkedin", "occ", "referido"
  
  // Notas del admin
  notas           String?   @db.Text
  
  // Estado
  status          String    @default("available") // "available", "in_process", "hired", "inactive"

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relaciones
  experiences     Experience[]
  documents       CandidateDocument[]

  // Vincular con cuenta de usuario (opcional, para que candidato pueda loguearse)
  userId          Int?      @unique
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([userId])
  @@index([sexo])
  @@index([universidad])
  @@index([profile])
  @@index([seniority])
  @@index([status])
  @@index([source])
  @@index([añosExperiencia])
  @@index([createdAt])
}

// =============================================
// EXPERIENCIAS LABORALES DE CANDIDATOS
// =============================================
model Experience {
  id            Int       @id @default(autoincrement())
  
  // Relación con candidato
  candidateId   Int
  candidate     Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  // Datos de la experiencia
  empresa       String
  puesto        String
  ubicacion     String?
  
  // Fechas
  fechaInicio   DateTime
  fechaFin      DateTime? // null = trabajo actual
  esActual      Boolean   @default(false)
  
  // Descripción
  descripcion   String?   @db.Text
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([candidateId])
  @@index([empresa])
  @@index([fechaInicio])
}

// =============================================
// DOCUMENTOS DE CANDIDATOS
// =============================================
model CandidateDocument {
  id            Int       @id @default(autoincrement())

  // Relación con candidato
  candidateId   Int
  candidate     Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  // Datos del documento
  name          String    // Nombre descriptivo del documento
  fileUrl       String    // URL del archivo en Vercel Blob
  fileType      String?   // MIME type (pdf, image/jpeg, etc.)

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([candidateId])
}

// =============================================
// ESPECIALIDADES/PERFILES (CRUD Admin)
// =============================================
model Specialty {
  id            Int       @id @default(autoincrement())
  
  // Nombre del perfil (ej: "Tecnología", "Diseño Gráfico")
  name          String    @unique
  
  // Slug para URLs (ej: "tecnologia", "diseno-grafico")
  slug          String    @unique
  
  // Descripción opcional
  description   String?
  
  // Icono (nombre de Lucide icon o emoji)
  icon          String?
  
  // Color para UI (hex)
  color         String?   @default("#2b5d62")
  
  // Subcategorías (JSON array de strings)
  subcategories String[]  @default([])
  
  // Orden de aparición
  sortOrder     Int       @default(0)
  
  // Estado
  isActive      Boolean   @default(true)
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([isActive])
  @@index([sortOrder])
  @@index([slug])
}

// =============================================
// SISTEMA DE ASIGNACIONES (Reclutador + Especialista)
// =============================================

// NOTA: Roles válidos en User:
// role String @default("user")
// Valores válidos: "admin", "company", "user", "recruiter", "specialist", "candidate"

// Asignación de vacante a Reclutador y Especialista
model JobAssignment {
  id              Int       @id @default(autoincrement())
  
  // Vacante asignada
  jobId           Int
  job             Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  // Reclutador asignado (psicólogo)
  recruiterId     Int?
  recruiter       User?     @relation("RecruiterAssignments", fields: [recruiterId], references: [id])
  
  // Especialista asignado (técnico)
  specialistId    Int?
  specialist      User?     @relation("SpecialistAssignments", fields: [specialistId], references: [id])
  
  // Estados del proceso
  // Reclutador: pending → reviewing → sent_to_specialist
  recruiterStatus   String    @default("pending")
  
  // Especialista: pending → evaluating → sent_to_company
  specialistStatus  String    @default("pending")
  
  // Notas
  recruiterNotes    String?   @db.Text
  specialistNotes   String?   @db.Text
  
  // Candidatos enviados al especialista (IDs separados por coma)
  candidatesSentToSpecialist  String?
  
  // Candidatos enviados a la empresa (IDs separados por coma)
  candidatesSentToCompany     String?
  
  // Timestamps
  assignedAt        DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Seguimiento 45 días
  followUpDate      DateTime?
  followUpCompleted Boolean   @default(false)
  followUpNotes     String?
  
  @@unique([jobId])
  @@index([recruiterId])
  @@index([specialistId])
  @@index([recruiterStatus])
  @@index([specialistStatus])
}

// =============================================
// AGREGAR AL MODELO User (relaciones):
// =============================================
// Agregar estos campos al modelo User existente:
//
// // Especialidad (para specialists)
// specialty         String?
// 
// // Relaciones de asignaciones
// recruiterAssignments   JobAssignment[] @relation("RecruiterAssignments")
// specialistAssignments  JobAssignment[] @relation("SpecialistAssignments")

// =============================================
// AGREGAR AL MODELO Job (relación):
// =============================================
// Agregar este campo al modelo Job existente:
//
// assignment        JobAssignment?

// =============================================
// NOTAS DE EVALUACIÓN (Reclutadores y Especialistas)
// =============================================
model EvaluationNote {
  id            Int       @id @default(autoincrement())

  // Autor de la nota
  authorId      Int
  author        User      @relation("EvaluationNoteAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  authorRole    String    // "recruiter", "specialist"

  // Aplicación asociada
  applicationId Int
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  // Contenido
  content       String    @db.Text

  // Documento adjunto opcional
  documentUrl   String?
  documentName  String?

  // Visibilidad
  isPublic      Boolean   @default(false) // true = visible para empresa

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([applicationId])
  @@index([authorId])
  @@index([createdAt])
}

// =============================================
// CÓDIGOS DE DESCUENTO (Sistema de Vendors)
// =============================================
model DiscountCode {
  id                Int       @id @default(autoincrement())
  code              String    @unique

  // Vendor que creó el código
  userId            Int
  user              User      @relation("VendorCodes", fields: [userId], references: [id], onDelete: Cascade)

  // Porcentajes
  discountPercent   Float     @default(10)    // Descuento para el comprador
  commissionPercent Float     @default(10)    // Comisión para el vendor

  // Estado
  isActive          Boolean   @default(true)

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Usos del código
  uses              DiscountCodeUse[]

  @@index([userId])
  @@index([code])
  @@index([isActive])
}

// =============================================
// USO DE CÓDIGOS DE DESCUENTO
// =============================================
model DiscountCodeUse {
  id                Int       @id @default(autoincrement())

  // Código usado
  codeId            Int
  code              DiscountCode @relation(fields: [codeId], references: [id], onDelete: Cascade)

  // Compra asociada
  purchaseId        Int       @unique
  purchase          CreditPurchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  // Empresa que usó el código
  companyUserId     Int

  // Montos
  originalPrice     Float     // Precio original
  discountAmount    Float     // Cantidad descontada
  finalPrice        Float     // Precio final pagado
  commissionAmount  Float     // Comisión para el vendor

  // Estado de la comisión
  commissionStatus  String    @default("pending") // "pending", "paid"
  commissionPaidAt  DateTime?
  paymentProofUrl   String?   // Comprobante de pago al vendor
  paymentDueDate    DateTime? // Fecha límite para pagar

  // Timestamp
  createdAt         DateTime  @default(now())

  @@index([codeId])
  @@index([companyUserId])
  @@index([commissionStatus])
  @@index([createdAt])
}

// =============================================
// SOLICITUDES DE ENTREVISTA
// =============================================
model InterviewRequest {
  id              Int       @id @default(autoincrement())

  // Relación con aplicación
  applicationId   Int
  application     Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  // Quien solicita (empresa)
  requestedById   Int
  requestedBy     User      @relation("InterviewRequester", fields: [requestedById], references: [id])

  // Configuración
  type            String    // "videocall", "presential"
  duration        Int       @default(45) // minutos
  participants    String?   @db.Text // JSON: [{nombre, email}]

  // Horarios propuestos
  availableSlots  String    @db.Text // JSON: [{date, time}]

  // Mensaje opcional
  message         String?   @db.Text

  // Estado
  status          String    @default("pending") // "pending", "confirmed", "rejected", "cancelled"
  confirmedSlot   String?   // JSON: {date, time} — el slot confirmado
  confirmedAt     DateTime?
  confirmedById   Int?      // userId de quien confirma

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([applicationId])
  @@index([requestedById])
  @@index([status])
}

